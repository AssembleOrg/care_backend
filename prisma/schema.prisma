generator client {
  provider = "prisma-client-js"
}

// Configurar seed en package.json: "prisma": { "seed": "tsx prisma/seed.ts" }

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Cuidador {
  id            String   @id @default(uuid())
  nombreCompleto String  @db.Text
  dniEnc         String
  dniHash        String  @unique
  telefonoEnc    String?
  telefonoHash   String? @unique
  emailEnc       String?
  emailHash      String? @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  asignaciones   Asignacion[]
  pagos          Pago[]

}

model PersonaAsistida {
  id                        String   @id @default(uuid())
  nombreCompleto            String   @db.Text
  dniEnc                    String?
  dniHash                   String?  @unique
  telefonoEnc               String?
  telefonoHash              String?  @unique
  direccionEnc              String?  @db.Text
  direccionHash             String?
  telefonoContactoEmergenciaEnc String?
  telefonoContactoEmergenciaHash String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  asignaciones              Asignacion[]
  pagos                     Pago[]
  contratos                 Contrato[]

}

model Asignacion {
  id            String    @id @default(uuid())
  cuidadorId    String
  personaId     String
  precioPorHora Decimal   @db.Decimal(10, 2)
  fechaInicio   DateTime
  fechaFin      DateTime?
  horarios      Json      // Array de { diaSemana: 0-6, horaInicio: "HH:MM", horaFin: "HH:MM" }
  notas         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  cuidador      Cuidador      @relation(fields: [cuidadorId], references: [id], onDelete: Cascade)
  persona       PersonaAsistida @relation(fields: [personaId], references: [id], onDelete: Cascade)

}

model Pago {
  id            String   @id @default(uuid())
  cuidadorId    String
  personaId     String?
  monto         Decimal  @db.Decimal(10, 2)
  fecha         DateTime
  metodo        String
  nota          String?  @db.Text
  // Campos para liquidación
  esLiquidacion Boolean  @default(false)
  precioPorHora Decimal? @db.Decimal(10, 2)
  horasTrabajadas Decimal? @db.Decimal(10, 2)
  semanaInicio  DateTime?
  semanaFin     DateTime?
  horarios      Json?    // Array de { dia, horaInicio, horaFin, horas }
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  cuidador      Cuidador      @relation(fields: [cuidadorId], references: [id], onDelete: Cascade)
  persona       PersonaAsistida? @relation(fields: [personaId], references: [id], onDelete: SetNull)
  recibos       ReciboAdjunto[]

}

model ReciboAdjunto {
  id        String   @id @default(uuid())
  pagoId    String
  url       String   @db.Text
  filename  String
  createdAt DateTime @default(now())
  
  pago      Pago     @relation(fields: [pagoId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(uuid())
  actor     String
  action    String
  table     String
  recordId  String
  oldData   Json?
  newData   Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relaciones eliminadas para evitar conflictos de claves foráneas con recordId polimórfico
  // cuidador      Cuidador?      @relation("CuidadorAuditLogs", fields: [recordId], references: [id], map: "AuditLog_Cuidador_fkey")
  // persona       PersonaAsistida? @relation("PersonaAsistidaAuditLogs", fields: [recordId], references: [id], map: "AuditLog_Persona_fkey")
  // asignacion    Asignacion?    @relation("AsignacionAuditLogs", fields: [recordId], references: [id], map: "AuditLog_Asignacion_fkey")
  // pago          Pago?          @relation("PagoAuditLogs", fields: [recordId], references: [id], map: "AuditLog_Pago_fkey")
}

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contrato{
  id        String   @id @default(uuid())
  idCliente String?               //Referencia a ID de personaAsistida. Validaciones en DTO!

  nombreManual String?           //Nombre manual del contrato. Validaciones en DTO!
  nombreManualHash String?       @unique
  cuitManual String?            
  cuitManualHash String?        @unique
  direccionManual String?       
  direccionManualHash String?   @unique

  telefonoEmergencia String?
  telefonoEmergenciaHash String? @unique

  fechaInicio   DateTime        //Fecha inicio contrato
  fechaFin      DateTime          //Fecha fin contrato

  persona       PersonaAsistida? @relation(fields: [idCliente], references: [id])

  createdAt     DateTime  @default(now())
}
