generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Cuidador {
  id                String               @id @default(uuid())
  nombreCompleto    String
  dniEnc            String
  dniHash           String               @unique
  telefonoEnc       String?
  telefonoHash      String?              @unique
  emailEnc          String?
  emailHash         String?              @unique
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  asignaciones      AsignacionCuidador[]
  pagos             Pago[]
  personasAsistidas PersonaCuidador[]
}

model PersonaAsistida {
  id                             String            @id @default(uuid())
  nombreCompleto                 String
  dniEnc                         String?
  dniHash                        String?           @unique
  telefonoEnc                    String?
  telefonoHash                   String?           @unique
  direccionEnc                   String?
  direccionHash                  String?
  telefonoContactoEmergenciaEnc  String?
  telefonoContactoEmergenciaHash String?
  createdAt                      DateTime          @default(now())
  updatedAt                      DateTime          @updatedAt
  asignaciones                   Asignacion[]
  pagos                          Pago[]
  cuidadores                     PersonaCuidador[]
}

model PersonaCuidador {
  id          String          @id @default(uuid())
  personaId   String
  cuidadorId  String
  fechaInicio DateTime        @default(now())
  fechaFin    DateTime?
  activo      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  cuidador    Cuidador        @relation(fields: [cuidadorId], references: [id], onDelete: Cascade)
  persona     PersonaAsistida @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, cuidadorId, fechaInicio])
  @@index([personaId])
  @@index([cuidadorId])
}

model Asignacion {
  id                String               @id @default(uuid())
  personaId         String
  fechaInicio       DateTime
  fechaFin          DateTime?
  horarios          Json?                // Opcional: d√≠as de la semana (0-6)
  horasPorCuidador  Json?                // { cuidadorId: { horas: number, precioPorHora: number } }
  notas             String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  persona           PersonaAsistida      @relation(fields: [personaId], references: [id], onDelete: Cascade)
  cuidadores        AsignacionCuidador[]
  pagos             Pago[]
}

model AsignacionCuidador {
  id           String     @id @default(uuid())
  asignacionId String
  cuidadorId   String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  asignacion   Asignacion @relation(fields: [asignacionId], references: [id], onDelete: Cascade)
  cuidador     Cuidador   @relation(fields: [cuidadorId], references: [id], onDelete: Cascade)

  @@unique([asignacionId, cuidadorId])
  @@index([asignacionId])
  @@index([cuidadorId])
}

model Pago {
  id              String           @id @default(uuid())
  cuidadorId      String
  personaId       String?
  asignacionId    String?
  monto           Decimal          @db.Decimal(10, 2)
  fecha           DateTime
  metodo          String            @default("LIQUIDACION")
  nota            String?
  precioPorHora   Decimal           @db.Decimal(10, 2)
  horasTrabajadas Decimal           @db.Decimal(10, 2)
  semanaInicio    DateTime
  semanaFin       DateTime
  horarios        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  cuidador        Cuidador         @relation(fields: [cuidadorId], references: [id], onDelete: Cascade)
  persona         PersonaAsistida?  @relation(fields: [personaId], references: [id])
  asignacion      Asignacion?      @relation(fields: [asignacionId], references: [id], onDelete: SetNull)
  recibos         ReciboAdjunto[]
}

model ReciboAdjunto {
  id        String   @id @default(uuid())
  pagoId    String
  url       String
  filename  String
  createdAt DateTime @default(now())
  pago      Pago     @relation(fields: [pagoId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(uuid())
  actor     String
  action    String
  table     String
  recordId  String
  oldData   Json?
  newData   Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
}

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
